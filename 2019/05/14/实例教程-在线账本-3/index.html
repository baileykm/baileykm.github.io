<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Bailey">
  <!-- Open Graph Data -->
  <meta property="og:title" content="实例教程 - 在线账本 (三)"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="Bailey&#39;s Blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://baileykm.github.io"/>
  
    <link rel="alternate" href="/atom.xml" title="Bailey&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Bailey's Blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-139890203-1', 'auto');
        ga('send', 'pageview');
    </script>


</head>

  <body>
    <!-- 单篇文章内容页面 -->
<!-- Page Header -->

<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">实例教程 - 在线账本 (三)</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/baileykm">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:baileiz@163.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div id="article-content" class="col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Bailey</span>
          
          <!-- Date -->
          <span class="date-time info">
            On <span class="date">2019/05/14</span>
            <span class="time">23:59:28</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Category <!-- 文章内容页面中的 Categories 部分 -->


<a href="/categories/入门教程/">入门教程</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: <!-- 文章内容页中的 Tags 部分 -->


<a class="tag" href="/tags/Java/">#Java</a> <a class="tag" href="/tags/Web/">#Web</a> <a class="tag" href="/tags/jQuery/">#jQuery</a> <a class="tag" href="/tags/Ajax/">#Ajax</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>本节为系列教程的第三部分: <em>真正的在线记账本: 客户端 + 服务器 + 数据库</em>. </p>
<p>经过前两节的努力, 我们已经实现了一个客户端 + 服务器模式的在线记账本, 但记账数据并未保存到数据库, 当服务端重启数据将丢失, 本节我们将实现将数据保存到数据库, 实现一个真正意义上的 “在线记账本”.</p>
<a id="more"></a>
<div class="toc">

<!-- toc -->
<ul>
<li><a href="#12-chuang-jian-shu-ju-ku">12. 创建数据库</a></li>
<li><a href="#13-dui-jie-shu-ju-ku">13. 对接数据库</a><ul>
<li><a href="#13-1-zhun-bei-shu-ju-ku-qu-dong">13.1 准备数据库驱动</a></li>
<li><a href="#13-2-chuang-jian-shu-ju-ku-gong-ju-lei">13.2 创建数据库工具类</a></li>
<li><a href="#13-3-chuang-jian-shu-ju-ku-fang-wen-lei">13.3 创建数据库访问类</a></li>
</ul>
</li>
<li><a href="#14-zui-hou-yi-bu-da-gong-gao-cheng">14. 最后一步, 大功告成!</a></li>
</ul>
<!-- tocstop -->
</div>

<h1><a href="#12-chuang-jian-shu-ju-ku" class="header-anchor"></a><span id="12-chuang-jian-shu-ju-ku">12. 创建数据库</span></h1><p>本教程中我们使用 MySQL, 当然, 你也可以使用其它的 DBMS, 如: Microsoft SQL Server 等. </p>
<p>这只需要使用相应的 JDBC 驱动, 并变换一下连接参数即可 (见下文).</p>
<blockquote>
<p>MySQL 的安装与配置就不赘述了, 问度娘~</p>
</blockquote>
<p>创建一个名为 account_book 的数据库 (Schema):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> databae account_book;</span><br></pre></td></tr></table></figure>
<p>在 <code>account_book</code>数据库中创建基本表 <code>bills</code>, 用于存储账单数据:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`bills`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`amount`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`memo`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">20</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意观察 bills 表的结构, 它们与此前我们客户端/服务器端的数据模型是一致的.</p>
</blockquote>
<h1><a href="#13-dui-jie-shu-ju-ku" class="header-anchor"></a><span id="13-dui-jie-shu-ju-ku">13. 对接数据库</span></h1><h2><a href="#13-1-zhun-bei-shu-ju-ku-qu-dong" class="header-anchor"></a><span id="13-1-zhun-bei-shu-ju-ku-qu-dong">13.1 准备数据库驱动</span></h2><p>我们将使用 JDBC 连接 MySQL 数据库, 所以先得 <a href="/attachment/mysql-connector-java-5.1.22.jar">下载 MySQL 的驱动程序</a>.</p>
<p>然后, 将此驱动程序文件 (.jar) 放到上节创建的 <code>WEB-INF/lib</code>文件夹下 ( 和上节 web-lighter 的那些 jar 文件放在一起 )</p>
<p>最后, 在 IDEA 中驱动程序文件上点击右键, 右键菜单中选择 <em>Add As Library…</em>, 将其添加到构建路径.</p>
<p>完成后的 WEB-INFO 文件夹结构大概像这样:</p>
<p><img src="/images/20190514-11.png" alt="Configurations"></p>
<h2><a href="#13-2-chuang-jian-shu-ju-ku-gong-ju-lei" class="header-anchor"></a><span id="13-2-chuang-jian-shu-ju-ku-gong-ju-lei">13.2 创建数据库工具类</span></h2><p>与数据库交互时有很多参数和步骤是相同的, 为了统一管理, 我们先来创建一个数据库工具类.</p>
<p><strong>Code-13.2: DBUtil.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 数据库驱动程序名</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> String driver = <span class="string">"com.mysql.jdbc.Driver"</span>;</span><br><span class="line">    <span class="comment">// 数据连接地址</span></span><br><span class="line">    <span class="comment">// 注意其中的数据库名"account_book"</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> String url = <span class="string">"jdbc:mysql://localhost/account_book?autoReconnect=true"</span>;</span><br><span class="line">    <span class="comment">// 数据库登录名</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> String user = <span class="string">"root"</span>;</span><br><span class="line">    <span class="comment">// 数据库登录密码</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> String password = <span class="string">"1234"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据库连接对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(url, user, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DBUtil</code>类将数据库连接参数信息统一管理, 此外还提供了一个公有 (public) 静态(static) 方法<code>getConnection()</code> 返回数据库连接对象.</p>
<blockquote>
<p>这里的 DBUtil 只对取得数据库连接对象(Connection)这一功能进行的封装. 在未来实践的过程中你可能会意识到可以把更多的功能 (如: 查询/更新) 封装到 DBUtil 里.</p>
<p>注意: 第 12, 14, 16 行中的数据库名, 登录名, 密码改成你自己的!</p>
</blockquote>
<h2><a href="#13-3-chuang-jian-shu-ju-ku-fang-wen-lei" class="header-anchor"></a><span id="13-3-chuang-jian-shu-ju-ku-fang-wen-lei">13.3 创建数据库访问类</span></h2><p>现在让我们把跟数据库交互的相关操作都封装起来, 创建如下<code>AccountBookDAO</code>类:</p>
<blockquote>
<p>对照代码中的注释慢慢看…</p>
<p>本人有点懒, 若前面注释过的内容, 后面再出现就没再注释了, 所以请按顺序看.</p>
</blockquote>
<p><strong>Code-13.3: AccountBookDAO.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> example.vo.Bill;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountBookDAO</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询数据库中现有的账单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Bill&gt; <span class="title">queryBills</span><span class="params">()</span> <span class="keyword">throws</span> SQLException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;Bill&gt; bills = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得数据库连接对象, 参见 Code-13.2 第 19 ~ 22 行</span></span><br><span class="line">            conn = DBUtil.getConnection();</span><br><span class="line">            <span class="comment">// 创建语句(Statement)对象</span></span><br><span class="line">            stmt = conn.createStatement();</span><br><span class="line">            <span class="comment">// 执行查询, 查询到的结果放在结果集(ResultSet)中</span></span><br><span class="line">            <span class="comment">// 这里把账单按时间降序排序</span></span><br><span class="line">            rs = stmt.executeQuery(<span class="string">"select * from bills order by time desc;"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将查询到的每一条账单数据打包成一个 Bill 对象, 并放入 List&lt;Bill&gt;</span></span><br><span class="line">            <span class="comment">// 参见第 111 ~ 118 行</span></span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                bills.add(packBill(rs));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (rs != <span class="keyword">null</span>) rs.close();</span><br><span class="line">            <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) stmt.close();</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span>) conn.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回查询结果</span></span><br><span class="line">        <span class="keyword">return</span> bills;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存账单数据到数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Bill <span class="title">saveBill</span><span class="params">(Bill bill)</span> <span class="keyword">throws</span> SQLException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement pstm = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得数据库连接对象, 参见 Code-13.2 第 19 ~ 22 行</span></span><br><span class="line">            conn = DBUtil.getConnection();</span><br><span class="line">            String sql = <span class="string">"insert into bills(time, amount, memo) values (?, ?, ?)"</span>;</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 这里使用了 PreparedStatement, 支持参数占位符"?", 与第 24 行对比一下</span></span><br><span class="line">            <span class="comment">// Statement.RETURN_GENERATED_KEYS 参数要求 insert 执行成功后返回此记录的主键字段值</span></span><br><span class="line">            <span class="comment">// 对照第12节, 建表的 SQL 语句中ID字段是"自增长"型(AUTO_INCREMENT)</span></span><br><span class="line">            pstm = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 取得服务器当前系统时间</span></span><br><span class="line">            <span class="comment">// 若要保存的信息同时含日期和时间, 必须使用 Timestamp</span></span><br><span class="line">            Timestamp now = <span class="keyword">new</span> Timestamp(System.currentTimeMillis());</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 设置 PreparedStatement 的参数, 即 SQL 语句中的那些"?"</span></span><br><span class="line">            <span class="comment">// 注意在 JDBC 中, 第 1 个参数序号是 1, 而不是 0</span></span><br><span class="line">            pstm.setTimestamp(<span class="number">1</span>, now);</span><br><span class="line">            pstm.setInt(<span class="number">2</span>, bill.getAmount());</span><br><span class="line">            pstm.setString(<span class="number">3</span>, bill.getMemo());</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 执行数据库更新, 将账单数据保存到数据库</span></span><br><span class="line">            pstm.executeUpdate();</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 获得数据库端生成的主键值</span></span><br><span class="line">            rs = pstm.getGeneratedKeys();</span><br><span class="line">            <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                <span class="comment">// 将主键值和账单时间写入账单数据对象</span></span><br><span class="line">                <span class="comment">// 以保持数据模型与数据库中实际存储的数据一致</span></span><br><span class="line">                bill.setId(rs.getInt(<span class="number">1</span>));</span><br><span class="line">                bill.setTime(now);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"新增数据失败"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (rs != <span class="keyword">null</span>) rs.close();</span><br><span class="line">            <span class="keyword">if</span> (pstm != <span class="keyword">null</span>) pstm.close();</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span>) conn.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除账单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBill</span><span class="params">(Bill bill)</span> <span class="keyword">throws</span> SQLException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement pstm = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = DBUtil.getConnection();</span><br><span class="line">            String sql = <span class="string">"delete from bills where id = ?"</span>;</span><br><span class="line">            pstm = conn.prepareStatement(sql);</span><br><span class="line">            pstm.setInt(<span class="number">1</span>, bill.getId());</span><br><span class="line">            pstm.execute();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (pstm != <span class="keyword">null</span>) pstm.close();</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span>) conn.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 ResultSet 中的账单数据打包成 Bill 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bill <span class="title">packBill</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Bill bill = <span class="keyword">new</span> Bill();</span><br><span class="line">        bill.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">        bill.setTime(rs.getTimestamp(<span class="string">"time"</span>));</span><br><span class="line">        bill.setAmount(rs.getInt(<span class="string">"amount"</span>));</span><br><span class="line">        bill.setMemo(rs.getString(<span class="string">"memo"</span>));</span><br><span class="line">        <span class="keyword">return</span> bill;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述<code>AccountBookDAO</code>实现了对账单数据进行”查询/插入/删除”的封装. 修改功能并未实现, 留给你来完成.</p>
<p>​    </p>
<p>此外, 请注意: AccountBookDAO 与外界的接口部分转递的信息是最简单朴素的 <code>Bill</code> 或 <code>List&lt;Bill&gt;</code>. 也就是说, 我们要尽可能地让 AccountBookDAO 之外的世界不知道数据库和 JDBC 的存在, 也无需关心数据是怎么来的, 怎么保存的, 这同样是<strong>分层解耦</strong>的思想.</p>
<h1><a href="#14-zui-hou-yi-bu-da-gong-gao-cheng" class="header-anchor"></a><span id="14-zui-hou-yi-bu-da-gong-gao-cheng">14. 最后一步, 大功告成!</span></h1><p>最后我们来修改 <em>BillAction.java</em> 中的代码, 让它来与上面定义的 <em>AccountBookDAO</em> 对接, 而不是对接<em>AccountBookService</em>.</p>
<p><strong>Code-14.1: BillAction.java</strong> (修改后)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.action.ActionResult;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.action.ActionSupport;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Inject;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Param;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Request;</span><br><span class="line"><span class="keyword">import</span> example.dao.AccountBookDAO;</span><br><span class="line"><span class="keyword">import</span> example.service.AccountBookService;</span><br><span class="line"><span class="keyword">import</span> example.vo.Bill;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BillAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 响应前端 /wl/getBills 请求, 将账本中的所有账单记录返回前端.</span></span><br><span class="line">    <span class="comment">// 注意形参表中 @Inject 注解后不是 AccountBookService 了, 而变成 AccountBookDAO</span></span><br><span class="line">    <span class="meta">@Request</span>(url = <span class="string">"/getBills"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">getBills</span><span class="params">(@Inject AccountBookDAO dao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用 AccountBookDAO 从数据库中获得所有账单数据</span></span><br><span class="line">            <span class="comment">// ActionResult.success() 方法将账单数据封装为 JSON 字符串</span></span><br><span class="line">            <span class="keyword">return</span> ActionResult.success(dao.queryBills());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 若数据库交互异常, 向前端返回"出错"信息</span></span><br><span class="line">            <span class="keyword">return</span> ActionResult.failure();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应前端 /wl/saveOrUpdateBill 请求, 将账本中的所有账单记录返回前端.</span></span><br><span class="line">    <span class="comment">// 注意形参表中 @Inject 注解后不是 AccountBookService 了, 而变成 AccountBookDAO</span></span><br><span class="line">    <span class="meta">@Request</span>(url = <span class="string">"/saveOrUpdateBill"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">saveOrUpdateBill</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Inject AccountBookDAO dao,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Param(name = <span class="string">"action"</span>)</span> String action,</span></span><br><span class="line"><span class="function">            @<span class="title">Param</span><span class="params">(name = <span class="string">"bill"</span>)</span> Bill bill) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"append"</span>:</span><br><span class="line">                    <span class="comment">// 插入账单到数据库</span></span><br><span class="line">                    bill = dao.saveBill(bill);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"remove"</span>:</span><br><span class="line">                    <span class="comment">// 删除数据库中的账单记录</span></span><br><span class="line">                    dao.removeBill(bill);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将保存后的账单数据打包成 JSON 字符串返回前端</span></span><br><span class="line">            <span class="comment">// 注意这里必须把保存后的账单信息带回前端</span></span><br><span class="line">            <span class="comment">// 因为对于新增账单而言, 账单的 ID 和时间是在服务器端生成的</span></span><br><span class="line">            <span class="keyword">return</span> ActionResult.success(bill);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 若出错, 向前端返回"出错"信息</span></span><br><span class="line">            <span class="keyword">return</span> ActionResult.failure();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再开一个浏览器窗口, 打开第 (二)节教程, 仔细对比上面的代码(Code-14.1)和原先的代码(Code-10.1)的变化.</p>
<blockquote>
<p>其实, 关键的变化是我们把服务器端数据模型的交互操作从 <em>AccountBookService</em> 切换成了 <em>AccountBookDAO</em>.</p>
<p>这又是分层设计的优势的另一体现</p>
</blockquote>
<p>​    </p>
<p>重启一下服务器端 Tomcat, 浏览器里一顿操作之后是不是发现数据都已经保存到数据库里了.</p>
<p>此时, 即使重启服务器, 你的账本数据都还好好的在那里等着你. 这就是”真正的在线记账本”!</p>
<p>这回大家开心了吧~</p>
<p>​    </p>
<hr>
<p>按照惯例我们还是来小结一下:</p>
<ul>
<li><p>本节内容其实不多, 只是在第(二)节基础上把数据的存储位置切换到了数据库里. 问题的关键在于:</p>
<p> <strong>分层、低耦合的设计将使得程序变得条理清晰, 而又灵活. 在需要撤换某一层时, 低耦合的设计将使得这项工作简单且平顺地完成.</strong></p>
</li>
<li><p>反思 AccountBookDAO.java (Code-13.3) 的代码, 你也许会发现它并不那么优雅, 甚至有点点臃肿, 乱! </p>
<p>比如:</p>
<ol>
<li><p>那些 SQL 语句能否不用手工来写, 如果有工具能帮我们自动生成所需的 SQL 该有多好!</p>
</li>
<li><p>那个<code>packBill()</code>方法的作用在于把数据库查询结果 ResultSet 中的数据库封装成简单的值对象(bill, VO) , packBill() 里大量的代码都在做搬运工. 能否有工具能帮我们完成这个封装工作, 并维护 bill 的状态?</p>
<blockquote>
<p>严格来说, 与数据库中记录对应的 Java 对象应称作持久层对象(PO, Persistant Object). 在实践中, PO 除数据外可能还有状态等其它信息.</p>
<p>本例为了简单起见, 不想把事情搞大, 所以将就用一下此前定义的那个 VO (Value Object)</p>
</blockquote>
</li>
</ol>
<p>类似的问题还很多, 程序写得多了, 你就会有强烈的愿望, 想要有个东西来帮你完成与数据库交互这一层的封装,这就是所谓的<strong>持久层封装</strong>.</p>
<p>呵呵, 那还等什么? </p>
<p>继续学习ORM (Object Relational Mapping), 持久层框架 (如: Hibernate, myBatis, Cayenne…) , 它们就是你想要的. </p>
<blockquote>
<p>当然, 本人推荐 Cayenne, 本博客里好几篇介绍 Cayenne 的文章.</p>
</blockquote>
</li>
</ul>
<hr>
<p>​    </p>
<p>~ 全剧终 ~ </p>
<p>~ 点个关注呗 ~ </p>
<p>~ 掌声、鲜花、小礼物走一走呗 ~</p>
<p>​    </p>
<blockquote>
<p>如果你发现此教程中有错误, 比如: 按照教程来做就是不对, 或者有些地方没有解释清楚. 麻烦你告诉我, 我改 !</p>
<p>即使你天生丽质, 自己已经把教程中的错误摆平, 也一定记得告诉我, 我改 ! </p>
<p>免得折腾后来的同学 !</p>
</blockquote>

        </div>
        <p class="post-revise-info">
            Revised on <span class="date">2019/05/18 11:53:40</span> by Bailey
        </p>
        
        <!-- 上一篇/下一篇  -->
        <hr/>
        <ul class="post-paginator">
            <li class="next">
                
            </li>
            <li class="previous">
                
                    <div class="prevSlogan">Previous Post</div>
                    <a href= "/2019/05/14/实例教程-在线账本-2/" title= "实例教程 - 在线账本 (二)">
                        实例教程 - 在线账本 (二)
                    </a>
                
            </li>
        </ul>
      </div>
    </div>
  </div>
</article>

<script>
  var toc = document.querySelector(".toc");
  // 若有侧边目录, 则设置目录效果
  if (toc) {
    toc.onmouseover = function(){
      toc.classList.remove("toc-shrink");
    };
    toc.onmouseout = function(){
      toc.classList.add("toc-shrink");
    };

    // 延迟 5 秒后自动隐藏
    window.setTimeout(function(){
      toc.classList.add("toc-shrink");
    }, 5000);

    // 目录跟随滚动效果
    var setTocPosition = function() {
      //变量t是滚动条滚动时，距离顶部的距离
      var t = document.documentElement.scrollTop||document.body.scrollTop;
    
      //当滚动到距离顶部200px时，返回顶部的锚点显示
      if(t < 300){
        toc.style.top = (300 - t) + 'px';
      } else{          //恢复正常
        toc.style.top = "20px";
      }
    }

    window.onscroll = function(){
        setTocPosition();
    }
    setTocPosition();
  }
</script>


    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a> 
        <p class="copyright text-muted">
          Copyright By <a href="mailto:baileiz@163.com">Bailey.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<!-- <script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script> -->

  </body>
</html>

